version: v1.0
name: Build and deploy through docker
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'aprilmintacpineda/aws-sam-cli-deploy-nodejs:latest'
fail_fast:
  stop:
    when: 'true'
auto_cancel:
  queued:
    when: 'true'
blocks:
  - name: Dev
    task:
      secrets:
        - name: sls-proj-pronetplat-aa
      jobs:
        - name: AWS SAM CLI Deployment
          commands:
            - checkout
            # versions
            - sam --version
            - yarn --version
            - node --version
            - git --version
            # Iinstall dependencies and build source
            - yarn
            - NODE_ENV=production yarn build
            # install node modules on built lambda layer
            - cd build/dependencies/nodejs && yarn
            - cd ../../..
            # clean unneeded files
            - rm -rf build/dependencies/nodejs/package.json build/dependencies/nodejs/yarn.lock
            # setup lambda layer resources
            - mkdir -p build/dependencies/nodejs/resources
            - cp ~/firebase_admin.json build/dependencies/nodejs/resources/firebase_admin.json
            # build and deploy with AWS SAM
            - sam build
            - >
              sam deploy --stack-name sls-proj-pronetplat-aa-dev \
                --s3-prefix sls-proj-pronetplat-aa-dev \
                --parameter-overrides Stage=dev AppPackageName=com.aprmp.projpronetplataa.local JWTSecret=$JWT_SECRET \
                --tags what="sls-proj-pronetplat-aa" stage="dev"
    skip:
      when: branch = 'master'
