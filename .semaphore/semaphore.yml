version: v1.0
name: Build and deploy through docker
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'aprilmintacpineda/aws-sam-cli-deploy-nodejs:latest'
fail_fast:
  stop:
    when: 'true'
auto_cancel:
  queued:
    when: 'true'
blocks:
  - name: Dev
    task:
      secrets:
        - name: sls-proj-pronetplat-aa
      jobs:
        - name: Build and deploy
          commands:
            - checkout
        - name: Versions
          commands:
            - sam --version
            - yarn --version
            - node --version
            - git --version
        - name: Install dependencies and build source
          commands:
            - yarn
            - NODE_ENV=production yarn build
            # install node modules on built lambda layer
            - cd build/dependencies/nodejs && yarn
            # clean unneeded files
            - rm -rf build/dependencies/nodejs/package.json build/dependencies/nodejs/yarn.lock
        - name: Setup lambda layer resources
          commands:
            - mkdir -p build/dependencies/nodejs/resources
            - cp ~/jwt.key build/dependencies/nodejs/resources/jwt.key
            - cp ~/jwt.pub build/dependencies/nodejs/resources/jwt.pub
            - cp ~/firebase_admin.json build/dependencies/nodejs/resources/firebase_admin.json
        - name: Build and deploy with AWS SAM
          commands:
            - sam build
            - >
              sam deploy --stack-name sls-proj-pronetplat-aa-dev \
                --s3-prefix sls-proj-pronetplat-aa-dev \
                --parameter-overrides Stage=dev AppPackageName=com.aprmp.projpronetplataa.local \
                --tags what="sls-proj-pronetplat-aa" stage="dev"
    skip:
      when: branch = 'master'
