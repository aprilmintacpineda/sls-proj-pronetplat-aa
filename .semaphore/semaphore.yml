version: v1.0
name: Continuous Deployment
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
  containers:
    - name: main
      image: aprilmintacpineda/aws-sam-cli-deploy-nodejs:latest
global_job_config:
  secrets:
    - name: AWS Credentials
    - name: Dev Variables
blocks:
  - name: Development
    task:
      secrets:
        - name: Dev Variables
      env_vars:
        - name: FAUNA_ADMIN_KEY
          value: $FAUNA_ADMIN_KEY
        - name: JWT_SECRET
          value: $JWT_SECRET
      jobs:
        - name: Build and deploy
          commands:
            - checkout
            - yarn --prefer-offline
            - FAUNA_LEGACY=true FAUNA_NOPRINT=true yarn fauna:migrate
            - NODE_ENV=production yarn build
            - cd build
            - mkdir -p dependencies/resources
            - sam build --parallel
            - cp ~/firebase_admin.json dependencies/nodejs/resources/firebase_admin.json
            - > 
              sam deploy --stack-name sls-proj-pronetplat-aa-dev \
                --s3-prefix sls-proj-pronetplat-aa-dev \
                --parameter-overrides Stage=dev FaunadbSecret=$FAUNADB_SECRET \
                --tags what="sls-proj-pronetplat-aa" stage="dev"
            - cache store node_modules_$(cat yarn.lock | shasum) node_modules