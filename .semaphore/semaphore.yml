version: v1.0
name: Build and deploy through docker
agent:
  machine:
    type: e1-standard-4
    os_image: ubuntu1804
  containers:
    - name: main
      image: 'aprilmintacpineda/aws-sam-cli-deploy-nodejs:latest'
fail_fast:
  stop:
    when: 'true'
auto_cancel:
  queued:
    when: 'true'
blocks:
  - name: Hello World
    task:
      secrets:
        - name: sls-proj-pronetplat-aa
      jobs:
        - name: Test job
          commands:
            - checkout
            - sam --version
            - yarn --version
            - node --version
            - git --version
            - pwd
            - ls -lha ~/ | grep "jwt.key"
            - ls -lha ~/ | grep "jwt.pub"
            - ls -lha ~/ | grep "firebase_admin.json"
            # - yarn
            # - NODE_ENV=production yarn build
            # # install node modules on built lambda layer
            # - cd build/dependencies/nodejs && yarn
            # # clean unneeded files
            # - rm -rf build/dependencies/nodejs/package.json build/dependencies/nodejs/yarn.lock
            # # resources on lambda layer
            # - mkdir build/dependencies/nodejs/resources
            # - echo '${{ secrets.JWT_PRIVATE_KEY }}' > build/dependencies/nodejs/resources/jwt.key
            # - echo '${{ secrets.JWT_PUBLIC_KEY }}' > build/dependencies/nodejs/resources/jwt.pub
            # - echo '${{ secrets.FIREBASE_ADMIN_DEV }}' > build/dependencies/nodejs/resources/firebase_admin.json
    skip:
      when: branch = 'master'
